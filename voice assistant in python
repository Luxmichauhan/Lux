import os
import speech_recognition as sr
import pywhatkit
import datetime
import openai
import pyttsx3
import webbrowser

# Replace 'your_api_key_here' with your actual OpenAI API key
my_key = "your_api_key_here"

engine = pyttsx3.init()
voices = engine.getProperty('voices')
engine.setProperty('voice', voices[0].id)

chat_str = ""  # Define chat_str globally

# A function to convert text to speech
def talk(text):
    engine.say(text)
    engine.runAndWait()

def take_command():
    recognizer = sr.Recognizer()
    with sr.Microphone() as source:
        print("Listening")
        recognizer.adjust_for_ambient_noise(source)
        voice = recognizer.listen(source)
        try:
            print("Recognizing")
            command = recognizer.recognize_google(voice, language="en-in")
            return command
        except sr.UnknownValueError:
            talk('Sorry, I could not understand your speech. Please try again.')
            return take_command()
        except sr.RequestError:
            talk('Sorry, my speech recognition service is down.')
            return None

def chat(command_text):
    global chat_str
    print(chat_str)
    openai.api_key = my_key
    chat_str += f"User: {command_text}\n"
    response = openai.Completion.create(
        model="gpt-3.5-turbo-instruct",
        prompt=chat_str,
        temperature=0.7,
        max_tokens=125,
        top_p=1,
        frequency_penalty=0,
        presence_penalty=0
    )
    talk(response.choices[0].text)
    chat_str += f"{response.choices[0].text}\n"
    return response.choices[0].text

def run_buddy():
    talk("How can I help you?")
    while True:
        print('Listening')
        command = take_command()
        print(command)
        if command:
            if "play".lower() in command.lower():
                video = command.replace('play', '')
                pywhatkit.playonyt(video)
                talk('Playing ' + video)
            elif "whatsapp message".lower() in command.lower():
                talk('Please speak the contact name:')
                contact_name = take_command()
                talk('Please speak the message:')
                message_text = take_command()
                if contact_name and message_text:
                    contact_mapping = {
                        "myself": '+917988874807'
                        # Add more contacts as needed
                    }
                    if contact_name.lower() in contact_mapping:
                        recipient_number = contact_mapping.get(contact_name)
                        pywhatkit.sendwhatmsg_instantly(phone_no=recipient_number, message=message_text)
                        talk('Message sent successfully!')
                    else:
                        talk('Sorry, contact not found')
                else:
                    talk('Sorry, cannot understand your speech')
            elif "open calculator".lower() in command.lower():
                talk('Opening calculator')
                os.system(r"start D:\Windows\SysWOW64\calc.exe")
            elif "search".lower() in command.lower():
                content = command.replace('search', '')
                talk(f"Search results for {content}")
                webbrowser.open(content)
            elif "tell me the time".lower() in command.lower():
                current_time = datetime.datetime.now().strftime('%I:%M %p')
                print(current_time)
                talk('Current time is ' + current_time)
            elif "tell me the date".lower() in command.lower():
                current_date = datetime.datetime.now().strftime("%d %B, %Y")
                print(current_date)
                talk('Today is ' + current_date)
            elif "exit".lower() in command.lower():
                talk('Goodbye!')
                exit()
            else:
                chat_response = chat(command)
                talk(chat_response)
        else:
            talk('Sorry, I could not understand your speech. Please try again.')

if __name__ == "__main__":
    run_buddy()
